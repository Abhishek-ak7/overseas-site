---
- name: Setup & Deploy Next.js Application on AWS EC2
  hosts: nextjs
  become: yes
  vars:
    app_name: bnoverseas-app
    app_port: 3000
    app_user: ubuntu
    app_group: ubuntu
    node_version: "20"
    repo_url: "https://github.com/Abhishek-ak7/overseas-site.git"
    app_directory: "/var/www/{{ app_name }}"
    env_file: "{{ app_directory }}/.env.local"
    domain_name: "{{ ansible_host }}"  # EC2 public IP auto

  tasks:

    # Step 1: System Updates
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade packages
      ansible.builtin.apt:
        upgrade: dist

    - name: Install dependencies
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - git
          - build-essential
          - ufw
          - htop
          - nano
          - net-tools
          - python3-pip
        state: present

    # Step 2: Install Node.js
    - name: Add NodeSource repo
      ansible.builtin.shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Install nodejs
      ansible.builtin.apt:
        name: nodejs
        state: present

    - name: Show installed Node + npm
      ansible.builtin.shell: node -v && npm -v
      register: versions
      changed_when: false

    - ansible.builtin.debug:
        msg: "{{ versions.stdout }}"

    # Step 3: Install & Start Nginx
    - name: Install nginx
      ansible.builtin.apt:
        name: nginx
        state: present

    - name: Enable nginx
      ansible.builtin.systemd:
        name: nginx
        enabled: yes
        state: started

    # Step 4: Firewall
    - name: Allow essential ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: [ "22", "80", "443" ]
      ignore_errors: yes

    - name: Enable UFW
      community.general.ufw:
        state: enabled
        policy: allow
      ignore_errors: yes

    # Step 5: App Directory
    - name: Ensure app directory exists
      ansible.builtin.file:
        path: "{{ app_directory }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    # Step 5.1: Pull Latest Repo
    - name: Clone repository
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ app_directory }}"
        version: main
        update: yes
        force: yes
      become_user: ubuntu

    # Step 5.2: Swap for NPM Builds
    - name: Create 2GB swap if not exists
      ansible.builtin.shell: |
        if [ ! -f /swapfile ]; then
          fallocate -l 2G /swapfile
          chmod 600 /swapfile
          mkswap /swapfile
          swapon /swapfile
          echo "/swapfile none swap sw 0 0" >> /etc/fstab
        fi

    # Step 5.3: Safe .env.local
    - name: Ensure env file exists
      ansible.builtin.shell: |
        if [ -f {{ app_directory }}/.env.example ]; then
          cp {{ app_directory }}/.env.example {{ env_file }};
        else
          echo "# created by Ansible" > {{ env_file }};
        fi
        chown ubuntu:ubuntu {{ env_file }}
        chmod 600 {{ env_file }}

    - name: Notify about env
      ansible.builtin.debug:
        msg:
          - "Edit env file manually: nano {{ env_file }}"
          - "Add DATABASE_URL, NEXTAUTH_SECRET, AWS keys, etc."

    # Step 6: npm install + build
    - name: Install dependencies
      ansible.builtin.shell: |
        cd {{ app_directory }}
        npm install --legacy-peer-deps --no-audit --no-fund
      become_user: ubuntu
      environment:
        NODE_OPTIONS: "--max-old-space-size=1024"

    - name: Build Next.js
      ansible.builtin.shell: |
        cd {{ app_directory }}
        npm run build
      become_user: ubuntu
      environment:
        NODE_ENV: production
        NODE_OPTIONS: "--max-old-space-size=1024"

    # Step 7: PM2
    - name: Install pm2
      community.general.npm:
        name: pm2
        global: yes

    - name: Start app with PM2
      ansible.builtin.shell: |
        cd {{ app_directory }}
        pm2 delete "{{ app_name }}" || true
        pm2 start npm --name "{{ app_name }}" -- start
        pm2 startup
        pm2 save
      become_user: ubuntu

    # Step 8: NGINX Reverse Proxy
    - name: Configure Nginx site
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/nextjs
        content: |
          server {
            listen 80;
            server_name {{ domain_name }};

            location / {
              proxy_pass http://127.0.0.1:{{ app_port }};
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
            }
          }

    - name: Enable site
      ansible.builtin.shell: |
        ln -sf /etc/nginx/sites-available/nextjs /etc/nginx/sites-enabled/nextjs
        rm -f /etc/nginx/sites-enabled/default
        nginx -t
        systemctl reload nginx

    # Step 9: Skip SSL
    - ansible.builtin.debug:
        msg: "SSL skipped. Access: http://{{ domain_name }}/"

    # Step 10: Summary
    - ansible.builtin.debug:
        msg:
          - "Deployment complete!"
          - "App running at http://{{ domain_name }}/"
          - "PM2 Name: {{ app_name }}"
