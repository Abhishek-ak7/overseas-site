---
- name: Setup & Deploy Next.js Application on AWS EC2
  hosts: nextjs
  become: yes
  vars:
    app_name: bnoverseas-app
    app_port: 3000
    app_user: ubuntu
    app_group: ubuntu
    node_version: "20"
    repo_url: "https://github.com/Abhishek-ak7/overseas-site.git"
    app_directory: "/var/www/{{ app_name }}"
    domain_name: "{{ ansible_host }}"  # ✅ use EC2 public IP automatically

  tasks:

    # Step 1: System Updates
    - name: Update package manager cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: ['setup']

    - name: Upgrade all packages
      apt:
        upgrade: dist
      tags: ['setup']

    - name: Install basic dependencies
      apt:
        name:
          - curl
          - wget
          - git
          - build-essential
          - ufw
          - htop
          - nano
          - net-tools
          - python3-pip
        state: present
      tags: ['setup']

    # Step 2: Install Node.js
    - name: Add Node.js repository
      shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list
      tags: ['setup']

    - name: Install Node.js and npm
      apt:
        name: nodejs
        state: present
      tags: ['setup']

    - name: Verify Node.js installation
      shell: node -v && npm -v
      register: node_version_check
      changed_when: false
      tags: ['setup']

    - name: Display Node.js and npm version
      debug:
        msg: "{{ node_version_check.stdout }}"
      tags: ['setup']

    # Step 3: Install and Start Nginx
    - name: Install Nginx
      apt:
        name: nginx
        state: present
      tags: ['setup']

    - name: Start Nginx service
      systemd:
        name: nginx
        enabled: yes
        state: started
      tags: ['setup']

    # Step 4: Configure Firewall
    - name: Allow HTTP, HTTPS, and SSH
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "22"
        - "80"
        - "443"
      ignore_errors: yes
      tags: ['setup']

    # Step 5: App Directory
    - name: Create app directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
      tags: ['deploy']

    # ✅ Step 5.1: Always pull latest repo code from GitHub
    - name: Pull latest Next.js code from GitHub
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_directory }}"
        version: main
        update: yes      # ✅ always check for new commits
        force: yes       # ✅ overwrite local changes
      become_user: "{{ app_user }}"
      tags: ['deploy']

    # ✅ Step 5.2: Add swap memory (for safe npm builds)
    - name: Add 2GB swap space if not exists
      shell: |
        if [ ! -f /swapfile ]; then
          sudo fallocate -l 2G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
        fi
      become: yes
      tags: ['deploy']

    # Step 6: Install Dependencies and Build
    - name: Install npm dependencies (ignore peer dependency conflicts)
      shell: |
        cd {{ app_directory }}
        npm install --legacy-peer-deps --no-audit --no-fund
      become_user: "{{ app_user }}"
      environment:
        NODE_OPTIONS: "--max-old-space-size=1024"
      tags: ['deploy']

    - name: Build Next.js application
      shell: |
        cd {{ app_directory }}
        npm run build
      become_user: "{{ app_user }}"
      environment:
        NODE_ENV: production
        NODE_OPTIONS: "--max-old-space-size=1024"
      tags: ['deploy']

    # Step 7: Install and Start with PM2
    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes
      tags: ['deploy']

    - name: Start application with PM2
      shell: |
        cd {{ app_directory }}
        pm2 delete "{{ app_name }}" || true
        pm2 start npm --name "{{ app_name }}" -- start
        pm2 startup
        pm2 save
      become_user: "{{ app_user }}"
      tags: ['deploy']

    # Step 8: Configure Nginx Reverse Proxy
    - name: Create Nginx configuration for public IP
      copy:
        dest: /etc/nginx/sites-available/nextjs
        content: |
          server {
              listen 80;
              server_name {{ domain_name }} _;

              location / {
                  proxy_pass http://127.0.0.1:{{ app_port }};
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_cache_bypass $http_upgrade;
              }
          }
        owner: root
        group: root
        mode: '0644'
      tags: ['deploy']

    - name: Enable Nginx site and reload
      shell: |
        ln -sf /etc/nginx/sites-available/nextjs /etc/nginx/sites-enabled/nextjs
        rm -f /etc/nginx/sites-enabled/default
        nginx -t
        systemctl reload nginx
      tags: ['deploy']

    # Step 9: Skip SSL (since no domain)
    - name: Skipping SSL setup (no domain)
      debug:
        msg: "Skipping Certbot SSL setup — no domain provided. Access your app via http://{{ domain_name }}/"
      tags: ['deploy']

    # Step 10: Display Summary
    - name: Display deployment summary
      debug:
        msg:
          - "✅ Next.js App Deployed Successfully!"
          - "Access it via: http://{{ domain_name }}/"
          - "PM2 app name: {{ app_name }}"
      tags: ['deploy']
