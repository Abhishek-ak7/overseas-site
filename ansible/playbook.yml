---
- name: Setup Next.js Application on AWS EC2
  hosts: nextjs
  become: yes
  vars:
    app_name: bnoverseas-app
    app_port: 3000
    app_user: ubuntu
    app_group: ubuntu
    node_version: "20"
    repo_url: "https://github.com/yourusername/your-nextjs-app.git"
    app_directory: "/var/www/{{ app_name }}"
    domain_name: "your-domain.com"  # Update this with your domain

  tasks:
    # Step 1: System Updates
    - name: Update package manager cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist

    - name: Install basic dependencies
      apt:
        name:
          - curl
          - wget
          - git
          - build-essential
          - ufw
          - htop
          - nano
          - net-tools
          - python3-pip
        state: present

    # Step 2: Install Node.js
    - name: Add Node.js repository
      shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Install Node.js and npm
      apt:
        name:
          - nodejs
        state: present

    - name: Verify Node.js installation
      shell: node -v && npm -v
      register: node_version_check
      changed_when: false

    - name: Display Node.js and npm version
      debug:
        msg: "{{ node_version_check.stdout }}"

    # Step 3: Install Nginx
    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Start Nginx service
      systemd:
        name: nginx
        enabled: yes
        state: started

    # Step 4: Configure Firewall
    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny
        direction: incoming

    - name: Allow SSH through firewall
      ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Allow HTTP through firewall
      ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Allow HTTPS through firewall
      ufw:
        rule: allow
        port: "443"
        proto: tcp

    # Step 5: Clone Repository
    - name: Create app directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    - name: Clone Next.js repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_directory }}"
        version: main
      become_user: "{{ app_user }}"
      register: git_clone
      failed_when: 
        - git_clone.failed
        - "'fatal' in git_clone.msg"

    # Step 6: Install Dependencies and Build
    - name: Install npm dependencies
      shell: |
        cd {{ app_directory }}
        npm install
      become_user: "{{ app_user }}"
      environment:
        NODE_ENV: production

    - name: Generate Prisma client
      shell: |
        cd {{ app_directory }}
        npm run db:generate
      become_user: "{{ app_user }}"
      ignore_errors: yes

    - name: Build Next.js application
      shell: |
        cd {{ app_directory }}
        npm run build
      become_user: "{{ app_user }}"
      environment:
        NODE_ENV: production

    # Step 7: Install and Configure PM2
    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes

    - name: Create PM2 ecosystem config file
      copy:
        dest: "{{ app_directory }}/ecosystem.config.js"
        content: |
          module.exports = {
            apps: [
              {
                name: "{{ app_name }}",
                script: "npm",
                args: "start",
                cwd: "{{ app_directory }}",
                instances: "max",
                exec_mode: "cluster",
                env: {
                  NODE_ENV: "production",
                  PORT: {{ app_port }}
                },
                error_file: "logs/error.log",
                out_file: "logs/out.log",
                log_date_format: "YYYY-MM-DD HH:mm:ss Z",
                merge_logs: true,
                autorestart: true,
                watch: false,
                max_memory_restart: "500M"
              }
            ]
          }
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'

    - name: Create logs directory
      file:
        path: "{{ app_directory }}/logs"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    - name: Start application with PM2
      shell: |
        cd {{ app_directory }}
        pm2 start ecosystem.config.js
        pm2 startup
        pm2 save
      become_user: "{{ app_user }}"
      environment:
        NODE_ENV: production
      register: pm2_start
      changed_when: "'started' in pm2_start.stdout"

    # Step 8: Configure Nginx as Reverse Proxy
    - name: Create Nginx configuration
      copy:
        dest: /etc/nginx/sites-available/nextjs
        content: |
          upstream nextjs {
            server 127.0.0.1:{{ app_port }};
          }

          server {
              listen 80;
              server_name {{ domain_name }} _;
              client_max_body_size 20M;

              location / {
                  proxy_pass http://nextjs;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
                  proxy_read_timeout 30s;
              }

              location /_next/static/ {
                  proxy_pass http://nextjs;
                  proxy_cache_valid 60m;
                  proxy_cache_bypass $http_upgrade;
                  expires 30d;
                  add_header Cache-Control "public, immutable";
              }

              location /api/ {
                  proxy_pass http://nextjs;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 60s;
              }
          }
        owner: root
        group: root
        mode: '0644'

    - name: Enable Nginx site
      shell: |
        ln -sf /etc/nginx/sites-available/nextjs /etc/nginx/sites-enabled/nextjs
        rm -f /etc/nginx/sites-enabled/default
      register: nginx_enable
      changed_when: "'ln:' in nginx_enable.stderr or nginx_enable.rc == 0"

    - name: Test Nginx configuration
      shell: nginx -t
      register: nginx_test
      changed_when: false

    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded

    # Step 9: SSL Certificate (Let's Encrypt)
    - name: Install Certbot and Nginx plugin
      apt:
        name:
          - certbot
          - python3-certbot-nginx
        state: present

    - name: Create SSL certificate (if domain is configured)
      shell: |
        certbot --nginx -d {{ domain_name }} --non-interactive --agree-tos -m admin@{{ domain_name }} --redirect
      when: domain_name != "your-domain.com"
      ignore_errors: yes

    # Step 10: Configure log rotation
    - name: Create logrotate configuration
      copy:
        dest: /etc/logrotate.d/nextjs-app
        content: |
          {{ app_directory }}/logs/*.log {
              daily
              rotate 7
              compress
              delaycompress
              notifempty
              create 0640 {{ app_user }} {{ app_group }}
              sharedscripts
              postrotate
                  systemctl reload nginx
              endscript
          }
        owner: root
        group: root
        mode: '0644'

    # Step 11: Create deployment helper scripts
    - name: Create deployment scripts directory
      file:
        path: "{{ app_directory }}/scripts"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    - name: Create update script
      copy:
        dest: "{{ app_directory }}/scripts/update.sh"
        content: |
          #!/bin/bash
          set -e
          echo "Pulling latest changes..."
          cd {{ app_directory }}
          git pull origin main
          echo "Installing dependencies..."
          npm install
          echo "Generating Prisma..."
          npm run db:generate || true
          echo "Building application..."
          npm run build
          echo "Restarting PM2..."
          pm2 restart all
          pm2 save
          echo "Deployment complete!"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    - name: Create status check script
      copy:
        dest: "{{ app_directory }}/scripts/status.sh"
        content: |
          #!/bin/bash
          echo "=== PM2 Status ==="
          pm2 status
          echo ""
          echo "=== Application Logs ==="
          pm2 logs --lines 50 --nostream
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    # Step 12: Summary
    - name: Display deployment summary
      debug:
        msg:
          - "========================================="
          - "‚úÖ Next.js Application Deployed Successfully!"
          - "========================================="
          - "Application Name: {{ app_name }}"
          - "Application Directory: {{ app_directory }}"
          - "Application Port: {{ app_port }}"
          - "Domain: {{ domain_name }}"
          - ""
          - "üìã Useful Commands:"
          - "  - Check status: pm2 status"
          - "  - View logs: pm2 logs"
          - "  - Restart app: pm2 restart all"
          - "  - Redeploy: cd {{ app_directory }} && ./scripts/update.sh"
          - ""
          - "üåç Access your application:"
          - "  - HTTP: http://{{ domain_name }}"
          - "  - HTTPS: https://{{ domain_name }}"
          - "========================================="
